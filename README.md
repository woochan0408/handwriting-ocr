# Handwrite-OCR: 손글씨 노트 디지털화 프로젝트

> 손글씨의 장점은 유지하면서, 디지털의 편의성을 더하다

## 목차
- [배경](#배경)
- [문제 정의](#문제-정의)
- [해결 전략](#해결-전략)
- [시스템 아키텍처](#시스템-아키텍처)
- [핵심 챌린지: 할루시네이션 해결](#핵심-챌린지-할루시네이션-해결)
- [기술 스택](#기술-스택)
- [실행 방법](#실행-방법)
- [결과 및 성과](#결과-및-성과)
- [한계 및 개선 방향](#한계-및-개선-방향)

---

## 배경

### 문제 상황

공부할 때 타이핑 필기와 손글씨 필기를 병행하고 있습니다. 손글씨 필기는 그림, 다이어그램, 수식을 자유롭게 표현할 수 있고 기억에도 오래 남는다는 장점이 있습니다. 하지만 복습할 때 노트를 일일이 찾아봐야 하고, 검색도 불가능해서 어떤 내용이 어디 있는지 기억에만 의존해야 합니다. 또한 타이핑 필기와 분리되어 관리되기 때문에 전체 학습 내용을 한눈에 보기 어렵습니다.

### 목표

손글씨의 장점(높은 자유도, 기억 효과)은 유지하면서 디지털의 편의성(검색, 복습, 통합 관리)을 더하고자 합니다. 이를 위해 손글씨 노트 이미지를 정제된 JSON 텍스트로 변환하는 시스템을 구축했습니다.

---

## 문제 정의

손글씨를 디지털화하려면 OCR이 필요한데, 기존 접근법에는 각각 치명적인 한계가 있었습니다.

### 기존 접근법의 딜레마

| | 전통적인 OCR | LLM 기반 OCR |
|-----------------|-------------|-------------|
| **정확도** | O 원본에 충실 | △ 할루시네이션 위험 |
| **텍스트 정제** | X 오탈자 많음, 문맥 무시 | O 구조화, 문맥 반영 |
| **표/그래프 이해** | X 텍스트만 추출 | O 이미지 캡셔닝 가능 |

**핵심 질문:**
> 어떻게 할루시네이션 없이 정제된 텍스트를 얻을 수 있을까?

---

## 해결 전략

### OCR First, LLM Second 하이브리드 파이프라인

두 접근법의 장점만 결합하는 전략:

1. **Stage 1-3: 정확한 원본 확보**
   Google Vision OCR로 실제 손글씨 텍스트 추출 (원본 충실도 확보)

2. **Stage 4: 안전한 정제**
   GPT-4로 후처리하되, **OCR 결과만을 기반으로 수정**하도록 제한
   → 할루시네이션 방지 + 구조화 달성

### 레이아웃 분석이 필요한 이유

손글씨 노트는 종종 2분할(좌/우) 또는 4분할 레이아웃을 사용합니다.

**문제점:**
전체 이미지를 한 번에 OCR하면 읽기 순서가 꼬임 (좌→우→좌→우 vs 좌 전체→우 전체)

**해결책:**
1. 레이아웃 자동 분석 (OpenCV Hough Line Transform)
2. 영역별로 이미지 분리
3. 각 영역을 독립적으로 OCR → 정제
4. 문맥이 유지되고 읽기 순서가 명확한 결과 산출

---

## 시스템 아키텍처

### 4단계 파이프라인

(작업 중)

### 주요 파일 설명

| 파일 | 역할 | 핵심 기술 |
|------|------|----------|
| `run_analysis.py` | 전체 파이프라인 오케스트레이션 | 단계별 자동 연계 |
| `note_boundary_detector.py` | 노트 경계 검출 | DocAligner (딥러닝) |
| `note_layout_analyzer.py` | 레이아웃 자동 분석 | Hough Line Transform |
| `note_ocr_processor.py` | 손글씨 텍스트 추출 | Google Vision API |
| `note_llm_postprocessor.py` | 텍스트 정제 및 구조화 | GPT-4 + 프롬프트 엔지니어링 |
| `simple_vision_ocr.py` | 레이아웃 분석 없는 단순 OCR (비교용) | Google Vision API |

---

## 핵심 챌린지: 할루시네이션 해결

### 문제 발견

초기 LLM 기반 OCR 후처리 시도 시 **심각한 할루시네이션** 발생:
- 없던 내용 추가
- 원본 의미 왜곡
- 정제 강도 ↔ 할루시네이션 간 **trade-off 관계** 발견

### 해결 과정

**1. OCR First 전략 채택**
- LLM은 후처리만 담당 (원본 생성 X)
- Google Vision OCR 결과를 반드시 참조하도록 제약

**2. Temperature 조정**
```python
temperature=0.3  # 낮은 값 → 창의성 억제 → 할루시네이션 감소
```

**3. 프롬프트 엔지니어링**
```
"제공된 OCR 텍스트만을 기반으로 수정하세요"
"없는 내용을 추가하지 마세요"
"원본의 의미를 유지하면서 오탈자만 수정하세요"
```

**4. 실제 테스트로 검증**
- 다양한 노트 샘플로 테스트
- 할루시네이션 발생률 **현저히 감소** 확인
- 원본 충실도 유지하면서 정제 품질 확보

### 현재 성과

- 원본에 없는 내용 추가 방지
- 오탈자 수정 및 띄어쓰기 정규화
- 문맥 기반 제목/단락 구조화
- 과목별 특수 표기 정제 (Java 코드, 수식 등)

---

## 기술 스택

### 선택 기준과 근거

| 기술 | 사용 이유 |
|------|----------|
| **DocAligner** | 노트 경계 검출에 특화된 딥러닝 모델 (94% 정확도) |
| **OpenCV** | 이미지 처리 및 Hough Line Transform 구현 |
| **Google Cloud Vision** | 손글씨 OCR에서 검증된 상용 API (document_text_detection) |
| **OpenAI GPT-4** | 한국어 문맥 이해 + 구조화 능력 우수 |
| **Python 3.11** | 라이브러리 호환성 + 빠른 개발 속도 |

### 의존성

```
docaligner-docsaid>=1.1.0    # 문서 경계 검출
opencv-python>=4.8.0         # 이미지 처리
google-cloud-vision>=3.4.0   # OCR
openai>=1.0.0                # LLM 후처리
numpy>=1.24.0                # 수치 연산
Pillow>=10.0.0               # 이미지 파일 핸들링
python-dotenv>=0.19.0        # 환경변수 관리
```

---

## 실행 방법

### 1. 사전 준비

**필수 요구사항:**
- Python 3.10 이상 (3.11.9 권장)
- Google Cloud Vision API 인증 정보
- OpenAI API 키

### 2. 설치

```bash
# 가상환경 생성 및 활성화
python -m venv venv
source venv/bin/activate  # Mac/Linux
# venv\Scripts\activate   # Windows

# 패키지 설치
pip install -r requirements.txt
```

### 3. 환경 설정

`.env` 파일 생성:
```bash
GOOGLE_APPLICATION_CREDENTIALS=path/to/your/google-credentials.json
OPENAI_API_KEY=your-openai-api-key
IMAGE_DIRECTORY=./test_images
IMAGE_FILENAME=your_image.jpg
```

### 4. 실행

**전체 파이프라인 실행 (권장):**
```bash
python run_analysis.py
```

**단계별 실행:**
```bash
# Stage 1: 경계 검출
python note_boundary_detector.py

# Stage 2: 레이아웃 분석
python note_layout_analyzer.py

# Stage 3: OCR 처리
python note_ocr_processor.py

# Stage 4: LLM 후처리
python note_llm_postprocessor.py
```

**레이아웃 분석 없는 단순 OCR (비교용):**
```bash
python simple_vision_ocr.py
```

### 5. 출력 파일

(작업 중)

---

## 결과 및 성과

(작업 중)

---

## 한계 및 개선 방향

### 현재 한계

**1. 정제 vs 할루시네이션 Trade-off**
- Temperature, 프롬프트로 완화했지만 완전 해결은 어려움
- 정제 강도를 높이면 할루시네이션 위험 증가

**2. 레이아웃 제약**
- 현재 지원: 0/2/4 영역만
- 미지원: 가로 분할, 곡선 분할, 불규칙 레이아웃

**3. OCR 품질 의존성**
- 손글씨 가독성에 따라 정확도 편차 큼
- 휘갈겨 쓴 글씨는 인식률 저하

**4. 비용**
- Google Vision API: 이미지당 과금
- OpenAI GPT-4: 토큰당 과금
- 대량 처리 시 비용 고려 필요

### 향후 개선 방향

**단기 (기능 개선):**
- [ ] 사용자가 정제 강도를 조절할 수 있는 옵션 추가
- [ ] OCR 신뢰도 기반 선택적 정제 (확신도 낮은 부분만 LLM 처리)
- [ ] 다양한 레이아웃 패턴 지원 (가로 분할, 3분할 등)
- [ ] 배치 처리 기능 (여러 이미지 한 번에 처리)

**중기 (품질 개선):**
- [ ] 다중 모델 앙상블 (여러 LLM 결과 비교 후 최적 선택)
- [ ] 사용자 피드백 루프 (수정 내역 학습)
- [ ] 표/그래프 영역 자동 감지 및 별도 처리
- [ ] 테스트 스위트 구축 및 자동화

**장기 (통합 관리):**
- [ ] 웹 UI 개발 (드래그 앤 드롭 업로드, 실시간 미리보기)
- [ ] 검색 가능한 노트 데이터베이스 구축
- [ ] 타이핑 필기와 통합 관리 플랫폼
- [ ] 플래시카드/Q&A 자동 생성 기능

---

## 라이선스 및 주의사항

**사용 API:**
- Google Cloud Vision API (유료)
- OpenAI API (유료)

**개인정보 보호:**
- 이미지 및 텍스트 데이터는 로컬에서만 처리
- API 전송 데이터는 각 서비스의 개인정보 정책 준수
- 민감한 정보가 포함된 노트 처리 시 주의 필요

